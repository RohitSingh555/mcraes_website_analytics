# McRAE's Website Analytics

A full-stack application with FastAPI backend and React frontend for syncing and viewing data from Scrunch AI API and Google Analytics 4 (GA4) to Supabase database.

## Features

- **Scrunch AI Integration**: Fetch brands, prompts, and responses from Scrunch AI API
- **Google Analytics 4 Integration**: Sync GA4 data for configured brands
- **Automated Daily Sync**: Cron job runs daily at 12:00 AM IST to sync all data
- **Real-time Dashboard**: React frontend for viewing analytics
- **Automatic Pagination**: Handles large datasets automatically
- **RESTful API**: Complete API endpoints for syncing and retrieving data

## Setup Steps

### 1. Prerequisites

- Python 3.8+
- Node.js 16+ (for frontend)
- Supabase account and project
- Google Analytics 4 service account credentials
- Scrunch AI API access

### 2. Install Dependencies

**Backend:**
```bash
pip install -r requirements.txt
```

**Frontend:**
```bash
cd frontend
npm install
```

### 3. Configure Environment Variables

1. Copy `.env.example` to `.env` (if exists) or create `.env`:
   ```bash
   copy .env.example .env
   ```

2. Edit `.env` and add your credentials:
   ```
   SUPABASE_URL=your_supabase_project_url
   SUPABASE_KEY=your_supabase_anon_key
   SCRUNCH_API_TOKEN=your_scrunch_api_token
   GA4_CREDENTIALS_PATH=service-key.json
   ```

### 4. Set Up Supabase Database

Run the following SQL scripts in your Supabase SQL Editor (in order):

1. **Main Schema**: `database_schema.sql` - Creates brands, prompts, responses tables
2. **GA4 Tables**: `ga4_tables_setup.sql` - Creates GA4 data storage tables
3. **GA4 Token Table**: `ga4_token_table.sql` - Creates token storage table

### 5. Google Analytics 4 Setup

1. **Service Account**: Place your GA4 service account JSON file as `service-key.json` in the project root
   - ⚠️ **Important**: This file contains sensitive credentials and should NEVER be committed to Git
   - The file is already in `.gitignore` for your protection

2. **Generate Access Token** (needed daily):
   ```bash
   python generate_ga4_token.py
   ```
   This token is automatically generated by the daily sync job.

3. **Configure GA4 Property IDs**: Update the `brands` table in Supabase:
   ```sql
   UPDATE brands SET ga4_property_id = 'YOUR_PROPERTY_ID' WHERE id = YOUR_BRAND_ID;
   ```

### 6. Run the Server

**Backend:**
```bash
python main.py
```
Or using uvicorn directly:
```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**Frontend:**
```bash
cd frontend
npm run dev
```

- Backend API: `http://localhost:8000`
- Frontend: `http://localhost:3000`
- API Docs: `http://localhost:8000/docs`

## Daily Automated Sync

The system includes a daily sync job that runs at **12:00 AM IST** to automatically sync:
1. GA4 Access Token (generates/refreshes daily)
2. Scrunch AI Data (brands, prompts, responses)
3. GA4 Data (for all brands with GA4 configured)

### Setup Daily Sync

**Windows (PowerShell as Administrator):**
```powershell
.\setup_daily_sync_windows.ps1
```

**Linux/Mac:**
```bash
chmod +x setup_daily_sync_linux.sh
./setup_daily_sync_linux.sh
```

### Manual Sync (Testing)

```bash
python daily_sync_job.py
```

**Note:** Make sure the API server is running before testing or scheduling the job.

## API Endpoints

### Health Check
- `GET /health` - Check server health

### Sync Endpoints

- `POST /api/v1/sync/brands` - Sync all brands
- `POST /api/v1/sync/prompts` - Sync all prompts
  - Query params: `stage`, `persona_id`
- `POST /api/v1/sync/responses` - Sync all responses
  - Query params: `platform`, `prompt_id`, `start_date`, `end_date`
- `POST /api/v1/sync/all` - Sync all Scrunch AI data (brands, prompts, responses)
- `POST /api/v1/sync/ga4` - Sync GA4 data for all configured brands
  - Query params: `brand_id`, `start_date`, `end_date`, `sync_realtime`
- `GET /api/v1/sync/status` - Get current sync status from database

### Data Endpoints

- `GET /api/v1/data/brands` - Get all brands
- `GET /api/v1/data/analytics/brands` - Get brand analytics
- `GET /api/v1/data/ga4/brand/{brand_id}` - Get GA4 analytics for a brand
- `GET /api/v1/data/ga4/properties` - List all GA4 properties

### API Documentation

Once the server is running, visit:
- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

## Usage Examples

### Sync all Scrunch AI data
```bash
curl -X POST "http://localhost:8000/api/v1/sync/all"
```

### Sync GA4 data for a specific brand
```bash
curl -X POST "http://localhost:8000/api/v1/sync/ga4?brand_id=3230"
```

### Get GA4 analytics for a brand
```bash
curl -X GET "http://localhost:8000/api/v1/data/ga4/brand/3230"
```

## Project Structure

```
.
├── app/                          # Backend application
│   ├── api/
│   │   ├── sync.py              # Sync endpoints
│   │   ├── data.py              # Data retrieval endpoints
│   │   └── database.py          # Database management endpoints
│   ├── core/
│   │   ├── config.py            # Configuration settings
│   │   ├── database.py          # Supabase client setup
│   │   └── logging_config.py    # Logging configuration
│   ├── services/
│   │   ├── scrunch_client.py    # Scrunch AI API client
│   │   ├── ga4_client.py        # GA4 API client
│   │   ├── ga4_token_service.py # GA4 token management
│   │   └── supabase_service.py  # Supabase service layer
│   └── db/
│       └── models.py            # SQLAlchemy models
├── frontend/                     # React frontend application
│   ├── src/
│   │   ├── components/          # React components
│   │   ├── services/            # API service
│   │   └── ...
│   └── package.json
├── main.py                       # FastAPI application entry point
├── daily_sync_job.py             # Daily automated sync script
├── generate_ga4_token.py         # GA4 token generator
├── database_schema.sql           # Main database schema
├── ga4_tables_setup.sql          # GA4 data tables
├── ga4_token_table.sql           # GA4 token storage table
├── requirements.txt              # Python dependencies
└── README.md                     # This file
```

## Database Schema

### Essential Tables

- **brands**: Stores brand information with GA4 property IDs
- **prompts**: Stores AI prompts linked to brands
- **responses**: Stores AI responses with analytics data
- **ga4_traffic_overview**: Daily GA4 traffic metrics
- **ga4_top_pages**: Top performing pages
- **ga4_traffic_sources**: Traffic acquisition channels
- **ga4_geographic**: Geographic breakdown
- **ga4_devices**: Device and platform breakdown
- **ga4_conversions**: Conversion events
- **ga4_realtime**: Realtime user data
- **ga4_tokens**: GA4 access token storage

See SQL files for complete schema definitions.

## Troubleshooting

1. **Database connection errors**: Verify your Supabase URL and key in `.env`
2. **API errors**: Check your Scrunch AI token is valid
3. **GA4 token errors**: Ensure `service-key.json` exists and has proper permissions
4. **Table errors**: Ensure all tables are created in Supabase using the SQL scripts
5. **Sync job fails**: Make sure the API server is running before the scheduled job executes
6. **Frontend not loading**: Check that the backend API is running on port 8000

## Notes

- The server handles pagination automatically (max 1000 items per request)
- Data is upserted (insert or update) based on ID
- Responses are immutable in Scrunch AI, so upserts are safe
- All timestamps are stored in UTC
- GA4 tokens expire daily and are automatically refreshed by the sync job
- The daily sync job requires the API server to be running

## License

Private - McRAE's Website Analytics
